<html>
  <head> <meta charset="utf-8"> <title>Dequenpeda-test</title> </head>
  <body>
    Please, switch to console.
    <script src="../dist/webrtc-dequenpeda.bundle.js"></script>
    <script>
      localStorage.debug = "tman-wrtc"
      let foglets = []
      const options = {
        delta: 30 * 1000,
        timeout: 15 * 1000,
        timeoutPending: 10 * 1000,
        timeoutDescriptor: 15 * 1000,
        periodicProfileExchange: 15 * 1000,
        socketClass: dequenpeda.AbstractSimplePeer
      }
      const number = 10
      for(let i = 0; i< number; i++) {
        foglets.push(new dequenpeda.Client({
          shuffleCountBeforeStart: 1,
          foglet: {
            rps: {
              options: {
                delta: options.delta,
                timeout: options.timeout,
                timeoutPending: options.timeoutPending,
                socketClass: options.socketClass
              }
            },
            overlays: [
              {
                name: 'son',
                class: dequenpeda.son,
                options: {
                  socketClass: options.socketClass,
                  profile: new (dequenpeda.profile)(),
                  delta: options.delta,
                  timeoutDescriptor: options.timeoutDescriptor,
                  timeout: options.timaout,
                  periodicProfileExchange: options.periodicProfileExchange,
                  protocol: 'dequenpeda-protocol-son-overlay', // foglet running on the protocol foglet-example, defined for spray-wrtc
                  signaling: {
                    address: 'https://localhost:8000/',
                    room: 'dequenpeda-room-overlay' // room to join
                  }
                }
              }
            ]
          }
        }))
        foglets[i].on('receive-broadcast',(message) => {
          console.log(message)
        })
      }

      for(let i = 0; i< number; i++) {
        if(i!==0) {
          foglets[i].connection(foglets[0]).then(() => {
            console.log('connected')
          }).catch(e => {
            console.error(e)
          })
        }
      }

      // let a = new dequenpeda.AbstractSimplePeer({initiator: true}), b = new dequenpeda.AbstractSimplePeer()
      // a.on('signal', (offer) => {
      //   console.log('a receive the offer', offer)
      //   b.signal(offer)
      // })
      // b.on('signal', (offer) => {
      //   console.log('b receive the offer', offer)
      //   a.signal(offer)
      // })
      // a.on('connect', () => {
      //   console.log('a connected')
      //   a.send('****this is a message****')
      // })
      // b.on('connect', () => {
      //   console.log('b connected')
      // })
      // b.on('data', (data) => {
      //   console.log('b receives data: ', data)
      //   b.send('****this is a reply****')
      // })
      // a.on('data', data => {
      //   console.log('a receives data: ', data)
      // })
    </script>
  </body>
</html>
